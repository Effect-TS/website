---
type: Tutorial
title: Calling an API
tags:
  - some
  - tags
sidebar:
  order: 4
---

Next up we're going to take a look at an endpoint that makes an API call to
another service. Here's the code:

```ts twoslash title=index.ts ins={9-19}
import express from "express";

import { NodeHttpServer, NodeRuntime } from "@effect/platform-node";
import { HttpRouter } from "@effect/platform";
import { Effect } from "effect";

const app = express();

app.get("/wow", async (req, res) => {
  const url = new URL(`https://owen-wilson-wow-api.onrender.com/wows/random`);

  const year = req.query.year;
  if (typeof year === "string") {
    url.searchParams.set("year", year);
  }

  const wow = await fetch(url.toString());
  res.json(await wow.json());
});

const router = HttpRouter.empty

const main = Effect.gen(function* () {
  app.use(yield* NodeHttpServer.makeHandler(router));
  app.listen(3000, () => {
    console.log("Server is running on http://localhost:3000");
  });
  yield* Effect.never;
});

NodeRuntime.runMain(main);
```

I've removed our `/health` and `/users` endpoints to keep the code to a
reasonable length.

For a bit of fun I've chosen the [Owen Wilson Wow
API](https://owen-wilson-wow-api.onrender.com/) as our API to call. I've also
decided to use a query parameter to filter the results by year, to show how this
works in Effect.

## Referencing the current request

If we were to reach straight away for `Effect.promise`, we would quickly
run into a problem: how do we reference the HTTP request object? We need to
get the `year` from the query parameters, but if you look back at our 
`/users` endpoint, you'll see that there's no request object.

```ts twoslash
import { Effect } from "effect";
import { HttpServerResponse } from "@effect/platform";
import { Client } from "pg";
const db = new Client({ user: "postgres" });
//---cut---
const users = Effect.promise(
  () => db.query("SELECT * FROM users"),
).pipe(
  Effect.map(({ rows }) => ({ users: rows })),
  Effect.flatMap(HttpServerResponse.json),
);
```

The way that Effect exposes the request object is through the
`HttpServerRequest` Effect. Near the start of this tutorial we used `Effect.gen`
to get the result of one Effect while inside another, and we can do the same
here.

```ts twoslash
import { Effect } from "effect";
//---cut---
import { HttpServerRequest, HttpServerResponse } from "@effect/platform";

const query = Effect.gen(function* () {
  const req = yield* HttpServerRequest.HttpServerRequest;
  return yield* HttpServerResponse.json({ url: req.url });
});
```

If we wire this handler up as a new `/query` endpoint in our application:

```ts twoslash
import { Effect } from "effect";
import { HttpRouter, HttpServerRequest, HttpServerResponse } from "@effect/platform";
const query = Effect.gen(function* () {
  const req = yield* HttpServerRequest.HttpServerRequest;
  return yield* HttpServerResponse.json({ url: req.url });
});
//---cut---
const router = HttpRouter.empty.pipe(
  HttpRouter.get("/query", query),
);
```

We can call it like so:

```shell
http get "localhost:3000/query?year=2010"
```

```http
HTTP/1.1 200 OK
Content-Length: 16
Content-Type: application/json
Date: Fri, 21 Feb 2025 16:41:03 GMT
X-Powered-By: Express

{
    "url": "/query?year=2010"
}
```

## Effect requirements

Let's look a bit closer at our `query` Effect:

```ts twoslash
import {
  HttpRouter,
  HttpServerRequest,
  HttpServerResponse,
} from "@effect/platform";
import { Effect } from "effect";
//---cut---
const query = Effect.gen(function* () {
  //  ^?
  const req = yield* HttpServerRequest.HttpServerRequest;
  return yield* HttpServerResponse.json({ url: req.url });
});
```

An Effect that returns an `HttpServerResponse`, may throw an `HttpBodyError`,
but also, for the first time, has something other than `never` in that third
spot. As a reminder, this is the `Requirement` type. What it's saying here is
that, to execute, this Effect requires an `HttpServerRequest`.

If we were to try and run this Effect directly, we would get a type error:

```ts twoslash
// @errors: 2379
import {
  HttpRouter,
  HttpServerRequest,
  HttpServerResponse,
} from "@effect/platform";
import { Effect } from "effect";
const query = Effect.gen(function* () {
  const req = yield* HttpServerRequest.HttpServerRequest;
  return yield* HttpServerResponse.json({ url: req.url });
});
//---cut---
Effect.runPromise(query);
```
